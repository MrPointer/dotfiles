# https://taskfile.dev
# Multi-OS Docker development environment management

version: "3"
silent: true

vars:
  SUPPORTED_OS: ubuntu,debian,fedora
  DEFAULT_OS: ubuntu

tasks:
  default:
    desc: List all available Docker environment tasks
    cmds:
      - task --list

  check:
    desc: Check if Docker and Docker Compose are available
    cmds:
      - |
        if ! command -v docker &> /dev/null; then
          echo "âŒ Docker is not installed or not in PATH"
          exit 1
        fi
        if ! command -v docker-compose &> /dev/null; then
          echo "âŒ Docker Compose is not installed or not in PATH"
          exit 1
        fi
        if ! docker info --format "{{`{{.Name}}`}}" &> /dev/null; then
          echo "âŒ Docker daemon is not running"
          exit 1
        fi
        echo "âœ… Docker environment is ready"

  list:
    desc: List all supported operating systems
    cmds:
      - |
        echo "ğŸ§ Supported operating systems:"
        echo "  â€¢ ubuntu  - Ubuntu Latest"
        echo "  â€¢ debian  - Debian Latest"
        echo "  â€¢ fedora  - Fedora Latest"
        echo ""
        echo "Usage examples:"
        echo "  task ubuntu:start    # Start Ubuntu environment"
        echo "  task debian:dev      # Start Debian environment and enter shell"
        echo "  task fedora:validate # Validate Fedora environment"

  # Ubuntu tasks
  ubuntu:build:
    desc: Build Ubuntu Docker image
    deps: [check]
    dir: ubuntu
    cmds:
      - echo "ğŸ”¨ Building Ubuntu Docker image..."
      - docker-compose build
      - echo "âœ… Ubuntu image built successfully"

  ubuntu:start:
    desc: Build and start Ubuntu testing environment
    deps: [check]
    dir: ubuntu
    cmds:
      - |
        if docker-compose ps | grep -q "installer-test-ubuntu-env.*Up"; then
          echo "âš ï¸  Ubuntu environment is already running"
        else
          echo "ğŸš€ Starting Ubuntu testing environment..."
          docker-compose up -d
          echo "âœ… Ubuntu environment started successfully"
          echo "ğŸ’¡ Use 'task ubuntu:shell' to enter the container"
        fi

  ubuntu:stop:
    desc: Stop Ubuntu testing environment
    deps: [check]
    dir: ubuntu
    cmds:
      - echo "â¹ï¸  Stopping Ubuntu testing environment..."
      - docker-compose down
      - echo "âœ… Ubuntu environment stopped"

  ubuntu:shell:
    desc: Enter Ubuntu container shell
    deps: [check]
    dir: ubuntu
    cmds:
      - |
        if ! docker-compose ps | grep -q "installer-test-ubuntu-env.*Up"; then
          echo "âš ï¸  Ubuntu environment is not running. Starting it now..."
          task ubuntu:start
          sleep 2
        fi
        echo "ğŸš Entering Ubuntu container shell..."
        docker-compose exec --user testuser installer-test-ubuntu bash

  ubuntu:dev:
    desc: Start Ubuntu environment and enter shell
    deps: [check]
    cmds:
      - task: ubuntu:start
      - task: ubuntu:shell

  ubuntu:validate:
    desc: Run validation tests in Ubuntu container
    deps: [check]
    dir: ubuntu
    cmds:
      - |
        if ! docker-compose ps | grep -q "installer-test-ubuntu-env.*Up"; then
          echo "âš ï¸  Ubuntu environment is not running. Starting it now..."
          task ubuntu:start
          sleep 2
        fi
        echo "ğŸ§ª Running Ubuntu validation tests..."
        docker-compose exec -T --user testuser installer-test-ubuntu /workspace/installer/docker/validate.sh

  ubuntu:rebuild:
    desc: Rebuild Ubuntu Docker image from scratch
    deps: [check]
    dir: ubuntu
    cmds:
      - echo "ğŸ”„ Rebuilding Ubuntu environment from scratch..."
      - docker-compose down
      - docker-compose build --no-cache
      - echo "âœ… Ubuntu environment rebuilt successfully"

  ubuntu:clean:
    desc: Stop Ubuntu containers and remove images
    deps: [check]
    dir: ubuntu
    cmds:
      - |
        echo "ğŸ§¹ Cleaning up Ubuntu environment..."
        docker-compose down || true
        if docker images --format "{{`{{.Repository}}`}}" | grep -q "ubuntu-installer-test-ubuntu"; then
          docker rmi ubuntu-installer-test-ubuntu 2>/dev/null || true
        fi
        echo "âœ… Ubuntu environment cleaned up"

  # Debian tasks
  debian:build:
    desc: Build Debian Docker image
    deps: [check]
    dir: debian
    cmds:
      - echo "ğŸ”¨ Building Debian Docker image..."
      - docker-compose build
      - echo "âœ… Debian image built successfully"

  debian:start:
    desc: Build and start Debian testing environment
    deps: [check]
    dir: debian
    cmds:
      - |
        if docker-compose ps | grep -q "installer-test-debian-env.*Up"; then
          echo "âš ï¸  Debian environment is already running"
        else
          echo "ğŸš€ Starting Debian testing environment..."
          docker-compose up -d
          echo "âœ… Debian environment started successfully"
          echo "ğŸ’¡ Use 'task debian:shell' to enter the container"
        fi

  debian:stop:
    desc: Stop Debian testing environment
    deps: [check]
    dir: debian
    cmds:
      - echo "â¹ï¸  Stopping Debian testing environment..."
      - docker-compose down
      - echo "âœ… Debian environment stopped"

  debian:shell:
    desc: Enter Debian container shell
    deps: [check]
    dir: debian
    cmds:
      - |
        if ! docker-compose ps | grep -q "installer-test-debian-env.*Up"; then
          echo "âš ï¸  Debian environment is not running. Starting it now..."
          task debian:start
          sleep 2
        fi
        echo "ğŸš Entering Debian container shell..."
        docker-compose exec --user testuser installer-test-debian bash

  debian:dev:
    desc: Start Debian environment and enter shell
    deps: [check]
    cmds:
      - task: debian:start
      - task: debian:shell

  debian:validate:
    desc: Run validation tests in Debian container
    deps: [check]
    dir: debian
    cmds:
      - |
        if ! docker-compose ps | grep -q "installer-test-debian-env.*Up"; then
          echo "âš ï¸  Debian environment is not running. Starting it now..."
          task debian:start
          sleep 2
        fi
        echo "ğŸ§ª Running Debian validation tests..."
        docker-compose exec -T --user testuser installer-test-debian /workspace/installer/docker/validate.sh

  debian:rebuild:
    desc: Rebuild Debian Docker image from scratch
    deps: [check]
    dir: debian
    cmds:
      - echo "ğŸ”„ Rebuilding Debian environment from scratch..."
      - docker-compose down
      - docker-compose build --no-cache
      - echo "âœ… Debian environment rebuilt successfully"

  debian:clean:
    desc: Stop Debian containers and remove images
    deps: [check]
    dir: debian
    cmds:
      - |
        echo "ğŸ§¹ Cleaning up Debian environment..."
        docker-compose down || true
        if docker images --format "{{`{{.Repository}}`}}" | grep -q "debian-installer-test-debian"; then
          docker rmi debian-installer-test-debian 2>/dev/null || true
        fi
        echo "âœ… Debian environment cleaned up"

  # Fedora tasks
  fedora:build:
    desc: Build Fedora Docker image
    deps: [check]
    dir: fedora
    cmds:
      - echo "ğŸ”¨ Building Fedora Docker image..."
      - docker-compose build
      - echo "âœ… Fedora image built successfully"

  fedora:start:
    desc: Build and start Fedora testing environment
    deps: [check]
    dir: fedora
    cmds:
      - |
        if docker-compose ps | grep -q "installer-test-fedora-env.*Up"; then
          echo "âš ï¸  Fedora environment is already running"
        else
          echo "ğŸš€ Starting Fedora testing environment..."
          docker-compose up -d
          echo "âœ… Fedora environment started successfully"
          echo "ğŸ’¡ Use 'task fedora:shell' to enter the container"
        fi

  fedora:stop:
    desc: Stop Fedora testing environment
    deps: [check]
    dir: fedora
    cmds:
      - echo "â¹ï¸  Stopping Fedora testing environment..."
      - docker-compose down
      - echo "âœ… Fedora environment stopped"

  fedora:shell:
    desc: Enter Fedora container shell
    deps: [check]
    dir: fedora
    cmds:
      - |
        if ! docker-compose ps | grep -q "installer-test-fedora-env.*Up"; then
          echo "âš ï¸  Fedora environment is not running. Starting it now..."
          task fedora:start
          sleep 2
        fi
        echo "ğŸš Entering Fedora container shell..."
        docker-compose exec --user testuser installer-test-fedora bash

  fedora:dev:
    desc: Start Fedora environment and enter shell
    deps: [check]
    cmds:
      - task: fedora:start
      - task: fedora:shell

  fedora:validate:
    desc: Run validation tests in Fedora container
    deps: [check]
    dir: fedora
    cmds:
      - |
        if ! docker-compose ps | grep -q "installer-test-fedora-env.*Up"; then
          echo "âš ï¸  Fedora environment is not running. Starting it now..."
          task fedora:start
          sleep 2
        fi
        echo "ğŸ§ª Running Fedora validation tests..."
        docker-compose exec -T --user testuser installer-test-fedora /workspace/installer/docker/validate.sh

  fedora:rebuild:
    desc: Rebuild Fedora Docker image from scratch
    deps: [check]
    dir: fedora
    cmds:
      - echo "ğŸ”„ Rebuilding Fedora environment from scratch..."
      - docker-compose down
      - docker-compose build --no-cache
      - echo "âœ… Fedora environment rebuilt successfully"

  fedora:clean:
    desc: Stop Fedora containers and remove images
    deps: [check]
    dir: fedora
    cmds:
      - |
        echo "ğŸ§¹ Cleaning up Fedora environment..."
        docker-compose down || true
        if docker images --format "{{`{{.Repository}}`}}" | grep -q "fedora-installer-test-fedora"; then
          docker rmi fedora-installer-test-fedora 2>/dev/null || true
        fi
        echo "âœ… Fedora environment cleaned up"

  # Utility tasks
  status:
    desc: Show status of all Docker environments
    deps: [check]
    cmds:
      - |
        echo "ğŸ“Š Docker Environment Status"
        echo "============================="
        echo ""
        echo "ğŸ§ Ubuntu:"
        if docker ps --format "{{`{{.Names}}`}}" | grep -q "installer-test-ubuntu-env"; then
          echo "  âœ… Running"
        else
          echo "  âŒ Stopped"
        fi
        echo ""
        echo "ğŸ§ Debian:"
        if docker ps --format "{{`{{.Names}}`}}" | grep -q "installer-test-debian-env"; then
          echo "  âœ… Running"
        else
          echo "  âŒ Stopped"
        fi
        echo ""
        echo "ğŸ§ Fedora:"
        if docker ps --format "{{`{{.Names}}`}}" | grep -q "installer-test-fedora-env"; then
          echo "  âœ… Running"
        else
          echo "  âŒ Stopped"
        fi

  stop-all:
    desc: Stop all Docker environments
    deps: [check]
    cmds:
      - task: ubuntu:stop
      - task: debian:stop
      - task: fedora:stop

  clean-all:
    desc: Clean up all Docker environments
    deps: [check]
    cmds:
      - task: ubuntu:clean
      - task: debian:clean
      - task: fedora:clean

  validate-all:
    desc: Run validation tests on all environments
    deps: [check]
    cmds:
      - echo "ğŸ§ª Running validation on all environments..."
      - task: ubuntu:validate
      - task: debian:validate
      - task: fedora:validate
      - echo "âœ… All validations completed"
